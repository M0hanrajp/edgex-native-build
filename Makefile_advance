# Function to show loading animation
define show_loading
  while :; do \
    for s in ⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏; do \
      printf "\r\033[33m$$s Container edgex-core-consul ::: started\033[0m"; \
      sleep 0.05; \
    done; \
  done
endef

# Function to check service status
define check_service
  START_TIME=$$(date +%s); \
  END_TIME=$$((START_TIME + 18)); \
  while :; do \
    CURRENT_TIME=$$(date +%s); \
    if [ $$CURRENT_TIME -ge $$END_TIME ]; then \
      printf "\r\033[31m⠹ Container edgex-core-consul ::: failed!\033[0m\n"; \
      kill $${LOADING_PID}; \
      break; \
    elif curl -s -o /dev/null -w "%{http_code}" http://127.0.0.2:8500/v1/status/leader | grep -q "200"; then \
      if [ $$CURRENT_TIME -ge $$((START_TIME + 5)) ]; then \
        printf "\r\033[32m✔ Container edgex-core-consul ::: Running\033[0m\n"; \
        kill $${LOADING_PID}; \
        break; \
      fi; \
    fi; \
    sleep 1; \
  done
endef

# Target to start all EdgeX services
start-all-services:
	@nohup consul agent -ui -bootstrap -server -client 127.0.0.1 -bind 127.0.0.1 -advertise 127.0.0.1 -data-dir=tmp/consul > ~/edgex-foundry/edgex-native-build-3.1-napa/edgex-service-logs/edgex-consul-agent/nohup.out 2>&1 &
	@$(call show_loading) & \
	LOADING_PID=$$!; \
	$(call check_service)
